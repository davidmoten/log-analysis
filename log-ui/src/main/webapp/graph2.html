<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>log-analysis3</title>
<link href="layout.css" rel="stylesheet" type="text/css">
<!--[if lte IE 8]><script language="javascript" type="text/javascript" src="../excanvas.min.js"></script><![endif]-->
<script language="javascript" type="text/javascript"
	src="js/flot/jquery.js"></script>
<script language="javascript" type="text/javascript"
	src="js/flot/jquery.flot.js"></script>

<script language="javascript" type="text/javascript"
        src="js/flot/jquery.flot.time.js"></script>

<link rel="stylesheet"
	href="http://code.jquery.com/ui/1.9.2/themes/base/jquery-ui.css" />
<!-- <script src="http://code.jquery.com/jquery-1.8.3.js"></script> -->
<script src="http://code.jquery.com/ui/1.9.2/jquery-ui.js"></script>
</head>
<body>

	<div id="graph" style="width:1200px;height:400px;"></div>
	<div id="error"></div>

	<script type="text/javascript">
$(function () {

	function getURLParameter(name) {
        return decodeURIComponent(
            (RegExp(name + '=' + '(.+?)(&|$)').exec(location.search)||[,null])[1]
        );
    }
	
	function getAbsolutePath() {
        var loc = window.location;
        var pathName = loc.pathname.substring(0, loc.pathname.lastIndexOf('/') + 1);
        return loc.href.substring(0, loc.href.length - ((loc.pathname + loc.search + loc.hash).length - pathName.length));
    }
	
	var now = new Date().getTime();
	var sql = "select logTimestamp, specialNumber as value from Dummy where specialNumber is not null order by logTimestamp";
	sql = sql.replace(" ","%20");
	var startTime = now - 3600000;
	var interval = 60000;
	var buckets = 60;
	var metric = "MEAN";
	var barOptions = { show: true, align: "center", barWidth: interval};
	
	function onDataReceived(series) {
	   	console.log(series);
	   	//series.lines = { show: true, steps: true, fill: true };
	   	series.bars = barOptions;
	   	series.points = { show: true };
		var options = {
				xaxis: {
			   	    mode: "time",
			   	    timeformat: "%H:%M"
			   	}
		};
		var meanGraph = {
                data: [[startTime,series.stats.mean],
                       [startTime+interval*buckets,series.stats.mean]],
                lines: { show: true }
        };
		var sdUpperGraph  = {
				data: [[startTime,series.stats.mean+series.stats.standardDeviation],
				       [startTime+interval*buckets,series.stats.mean + series.stats.standardDeviation]],
                lines: { show: true }
		}
		var sdLowerGraph  = {
				data: [[startTime,series.stats.mean-series.stats.standardDeviation],
				       [startTime+interval*buckets,series.stats.mean - series.stats.standardDeviation]],
                lines: { show: true }
		}
	   	$.plot($("#graph"), [ series, meanGraph,sdLowerGraph,sdUpperGraph ], options);
	}
	
	
	var dataurl =  "data?sql="+sql+"&start=" + startTime + "&interval="+ interval + "&buckets="+buckets+"&metric="+metric;
	console.log("dataurl=" + dataurl);
	$.ajax({
        url: dataurl,
        method: 'GET',
        dataType: 'json',
        success: onDataReceived,
        error: function (request, textStatus, errorThrown) {
        	console.log(errorThrown);
        	$("#error").text(errorThrown);
        },
        timeout: 60000
    });
})
    
  	</script>
</body>
</html>
