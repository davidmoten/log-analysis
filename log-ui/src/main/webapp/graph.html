
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>log-analysis</title>
    <link href="js/flot/layout.css" rel="stylesheet" type="text/css">
    <!--[if lte IE 8]><script language="javascript" type="text/javascript" src="../excanvas.min.js"></script><![endif]-->
    <script language="javascript" type="text/javascript" src="js/flot/jquery.js"></script>
    <script language="javascript" type="text/javascript" src="js/flot/jquery.flot.js"></script>
    
    <link rel="stylesheet" href="http://code.jquery.com/ui/1.9.2/themes/base/jquery-ui.css" />
    <!-- <script src="http://code.jquery.com/jquery-1.8.3.js"></script> -->
    <script src="http://code.jquery.com/ui/1.9.2/jquery-ui.js"></script>
 </head>
    <body>
    
    <form action="" method="get" style="margin-left:80px;">
    <p><textarea rows="5" cols="80" name="sql" id="sql" style="font-size:6;"></textarea></p>
    <p>Limit: <input type="text" name="limit" id="limit"/> <input type="submit" value="Execute"/></p> 
    </form>
    
    <p>Start: <input type="text" id="datepickerStart" /> </p>
    <p>Finish: <input type="text" id="datepickerFinish" /></p>
    
    <div id="error"></div>
    
    <div id="placeholder3" style="width:800px;height:500px"></div>
    
    

    <div id="placeholder" style="width:600px;height:300px"></div>

    <p>Flot supports lines, points, filled areas, bars and any
    combinations of these, in the same plot and even on the same data
    series.</p>
    
    <div id="placeholder2" style="width:600px;height:300px"></div>

<script type="text/javascript">
$(function () {
	
	//$( "#datepickerStart" ).datepicker("option", "dateFormat", "yyyy-mm-dd" );
    //$( "#datepickerFinish" ).datepicker("option", "dateFormat", "yyyy-mm-dd" );
    
	
    var d1 = [];
    for (var i = 0; i < 14; i += 0.5)
        d1.push([i, Math.sin(i)]);

    var d2 = [[0, 3], [4, 8], [8, 5], [9, 13]];

    var d3 = [];
    for (var i = 0; i < 14; i += 0.5)
        d3.push([i, Math.cos(i)]);

    var d4 = [];
    for (var i = 0; i < 14; i += 0.1)
        d4.push([i, Math.sqrt(i * 10)]);
    
    var d5 = [];
    for (var i = 0; i < 14; i += 0.5)
        d5.push([i, Math.sqrt(i)]);

    var d6 = [];
    for (var i = 0; i < 14; i += 0.5 + Math.random())
        d6.push([i, Math.sqrt(2*i + Math.sin(i) + 5)]);
                    
    if (false)
    $.plot($("#placeholder"), [
        {
            data: d1,
            lines: { show: true, fill: true }
        },
        {
            data: d2,
            bars: { show: true }
        },
        {
            data: d3,
            points: { show: true }
        },
        {
            data: d4,
            lines: { show: true }
        },
        {
            data: d5,
            lines: { show: true },
            points: { show: true }
        },
        {
            data: d6,
            lines: { show: true, steps: true }
        }
    ]);
    
    var d7 = [[100,45678],[200,56789],[300,36789],[400,27000]];
    
    if (false)
    $.plot($("#placeholder2"), [
                               {
                                   data: d7,
                                   bars: { show: true }
                               }
                           ]);
    
    function getAbsolutePath() {
        var loc = window.location;
        var pathName = loc.pathname.substring(0, loc.pathname.lastIndexOf('/') + 1);
        return loc.href.substring(0, loc.href.length - ((loc.pathname + loc.search + loc.hash).length - pathName.length));
    }
    
    function getURLParameter(name) {
        return decodeURIComponent(
            (RegExp(name + '=' + '(.+?)(&|$)').exec(location.search)||[,null])[1]
        );
    }
    
 // then fetch the data with jQuery
    function onDataReceived(series) {
    	$("#error").text("");
	 
	 	var d = [];
	 	
	 	var total = 0.0;
	 	var minT = null;
	 	var maxT = null;
	 	var count = 0;
	 	var now = new Date();
	 	var nowMs = now.getTime();
	    for (var i in series.result) {
	    	var t = (series.result[i].t-nowMs)/3600000.0;
	    	var val = series.result[i].value * 1.0;
	    	total += val * 1.0;
	    	//console.log("tstamp="+t + ",value="+ val);
	    	d.push([t,val]);
	    	if (minT === null || t < minT)
	    		minT = t;
	    	if (maxT === null || t > maxT)
	    		maxT = t;
	    	count ++;
	    }
	    
	    var mean = 0;
	    if (count >0)
	    	mean = total / count;
	    
	    console.log("mean="+ mean);
	 
        var options = {}; 
        
        var graph = {
                data: d,
                lines: { show: true },
                points: { show: true }
            };
        
        var meanGraph = {
                data: [[minT,mean],[maxT,mean]],
                lines: { show: true }
        };
        
        //console.log(graph);
        
        // and plot all we got
        $.plot($("#placeholder3"), [graph,meanGraph]);
     }
 
 	//var dataurl = "http://localhost:8000/graphs/logs/data.txt";
 	
 	//var dataurl = getAbsolutePath() + "/data.txt";
 	var dataurl;
 	if (getURLParameter("local") == "true")
 		dataurl = "data.txt";
 	else if (getUrlParameter("direct") == "true")
 	    dataurl = getAbsolutePath() + "query/logs/sql/" + getURLParameter("sql") + "/" + getURLParameter("limit") ;
 	else 
 		dataurl = "http://localhost:9191/query/sql="+ getURLParameter("sql") + "&start=" + (nowMs-3600000) + "&interval=3600&buckets=60&metric=MEAN";
 	console.log(dataurl);
 	
 	$("#sql").val(getURLParameter("sql"));
 	$("#limit").val(getURLParameter("limit"));
 	
    $.ajax({
        url: dataurl,
        method: 'GET',
        dataType: 'json',
        success: onDataReceived,
        error: function () {
        	$("#error").text("an error occurred");
        },
        timeout: 60000
    });
    
    
    
});
</script>

 </body>
</html>
