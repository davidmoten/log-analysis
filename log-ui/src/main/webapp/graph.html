<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>log-analysis</title>
<link href="layout.css" rel="stylesheet" type="text/css">

<!--[if lte IE 8]><script language="javascript" type="text/javascript" src="../excanvas.min.js"></script><![endif]-->
<script type="text/javascript" src="js/flot/jquery.js"></script>
<script type="text/javascript" src="js/flot/jquery.flot.js"></script>
<script type="text/javascript" src="js/flot/jquery.flot.time.js"></script>

<link rel="stylesheet"
	href="http://code.jquery.com/ui/1.9.2/themes/base/jquery-ui.css" />
<!-- <script src="http://code.jquery.com/jquery-1.8.3.js"></script> -->
<script src="http://code.jquery.com/ui/1.9.2/jquery-ui.js"></script>

<style type="text/css">
div.inline { float:left; }
.clearBoth { clear:both; }
</style>

</head>
<body>

	<div id="graph" style="width: 1200px; height: 400px;"></div>
	<div id="error"></div>
	<textarea id="sql" class='inline'  value="" cols="50" rows="4"></textarea>
	<div id="refresh" class="inline"><img src="images/refresh.png" style="height:16px;width:16px;"/></div>
	
	<script type="text/javascript">
		$(function() {

			function getURLParameter(name) {
				return decodeURIComponent((RegExp(name + '=' + '(.+?)(&|$)')
						.exec(location.search) || [ , null ])[1]);
			}

			function getAbsolutePath() {
				var loc = window.location;
				var pathName = loc.pathname.substring(0, loc.pathname
						.lastIndexOf('/') + 1);
				return loc.href
						.substring(
								0,
								loc.href.length
										- ((loc.pathname + loc.search + loc.hash).length - pathName.length));
			}

			var now = new Date().getTime();
			var sql = "select logTimestamp, specialNumber as value from Dummy where specialNumber is not null order by logTimestamp";
			sql = sql.replace(new RegExp(" ",'g'), "%20");
			var startTime = now - 3600000;
			var singleBucket = true;
			if (singleBucket) {
				var buckets = 0;
				var interval = 3600000;
			} else {
				var buckets = 60;
				var interval = 60000;
			}
			var metric = "MEAN";
			var barOptions = {
				show : true,
				align : "center",
				barWidth : interval
			};

			function onDataReceived(series) {
				console.log(series);
				var n;
				if (buckets>0) 
					n = buckets;
				else {
					n = 1;
					barOptions.barWidth=0;
				}
				
				//series.lines = { show: true, steps: true, fill: true };
				series.bars = barOptions;
				series.points = {
					show : true
				};
				var options = {
					xaxis : {
						mode : "time",
						timeformat : "%H:%M"
					}
				    //,colors: ["#d18b2c", "#dba255","#dba255", "#919733","#919733"]
				};
				
				var finishTime = startTime + interval *n;
				
				var meanGraph = {
					data : [
							[ startTime, series.stats.mean ],
							[ finishTime, series.stats.mean ] ],
					lines : {
						show : true
					}
				};
				var metricValue = series.stats.max;
				var metricGraph = {
						data : [
								[ startTime, metricValue ],
								[ finishTime, metricValue ] ],
						lines : {
							show : true
						}
					};
				var sdUpperGraph = {
					data : [
							[
									startTime,
									series.stats.mean
											+ series.stats.standardDeviation ],
							[
									finishTime,
									series.stats.mean
											+ series.stats.standardDeviation ] ],
					lines : {
						show : true
					}
				}
				var sdLowerGraph = {
					data : [
							[
									startTime,
									series.stats.mean
											- series.stats.standardDeviation ],
							[
									finishTime,
									series.stats.mean
											- series.stats.standardDeviation ] ],
					lines : {
						show : true
					}
				}
				$.plot($("#graph"), [ series, meanGraph, sdLowerGraph,
						sdUpperGraph,metricGraph ], options);
			}

			$("#sql").text(sql.replace(new RegExp("%20",'g'), " "));
			
			function refreshGraph() {
				var sql2 = $("#sql").val().replace(new RegExp(" ",'g'),"%20");
				
				var dataurl = "data?sql=" + sql2 + "&start=" + startTime
				+ "&interval=" + interval + "&buckets=" + buckets
				+ "&metric=" + metric;
				console.log("dataurl=" + dataurl);
		
				$.ajax({
					url : dataurl,
					method : 'GET',
					dataType : 'json',
					success : onDataReceived,
					error : function(request, textStatus, errorThrown) {
						console.log(errorThrown);
						$("#error").text(errorThrown);
					},
					timeout : 60000
				});
			}
			refreshGraph();
			$("#refresh").click(function( event ) {
                event.preventDefault();
                refreshGraph();
            });
		})
	</script>
</body>
</html>
