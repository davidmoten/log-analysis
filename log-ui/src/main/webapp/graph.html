<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>log-analysis</title>
<link href="layout.css" rel="stylesheet" type="text/css">

<!--[if lte IE 8]><script language="javascript" type="text/javascript" src="../excanvas.min.js"></script><![endif]-->
<script type="text/javascript" src="js/flot/jquery.js"></script>
<script type="text/javascript" src="js/flot/jquery.flot.js"></script>
<script type="text/javascript" src="js/flot/jquery.flot.time.js"></script>
<script type="text/javascript" src="js/log-analysis.js"></script>

<link rel="stylesheet"
	href="http://code.jquery.com/ui/1.9.2/themes/base/jquery-ui.css" />
<!-- <script src="http://code.jquery.com/jquery-1.8.3.js"></script> -->
<script src="http://code.jquery.com/ui/1.9.2/jquery-ui.js"></script>

<style type="text/css">
div.inline {
	float: left;
}

.clearBoth {
	clear: both;
}
</style>

</head>
<body>
	<div style="width: 100%;height:100%; position:absolute;">
	<div id="graph" style="width: 90%; height: 80%;"></div>
	<div id="error"></div>
	<div id="refresh" class="inline" style="margin-left:25px;">
		<img src="images/refresh.png" style="height: 16px; width: 16px;" />
	</div>
	<br/>
	<textarea id="sql" class='inline' style="font-size:9px; width:50%;margin: 0px 100px  auto;display:none" value="" cols="50" rows="4"></textarea>
	
	</div>

	<script type="text/javascript">
	
$(function() {

	function extractPeriod(s) {
		if (endsWith(s,"d"))
			return s.substring(0,s.length-1) * 24 * 3600000;
		else if (endsWith(s, "h"))
			return s.substring(0,s.length-1) * 3600000;
		else if (endsWith(s, "m"))
			return s.substring(0,s.length-1) * 60000;
		else if (endsWith(s, "s"))
			return s.substring(0,s.length-1) * 1000;
		else if (endsWith(s, "ms"))
			return s.substring(0,s.length-1);
		else 
			return Number(s);
	}
	
	// parse parameters from the url
	var now = new Date().getTime();
	var field = getURLParameter('field');
	var tablename = getURLParameter("table");
	if (tablename == null || tablename=="null")
		tablename="Entry";
	var buckets = Number(getURLParameter("buckets"));
	var interval = extractPeriod(getURLParameter("interval"));
	
	var n;
	if (buckets == 0)
		//no aggregation
		n = 1;
	else
		n = buckets;
	
	var finishTime = getURLParameter("finish");
	if (finishTime == "now") {
		var startTime = now - n * interval;
	} else
		//TOOD parse finish time/start time from url parameters
		startTime = now - n * interval;
	var metric = getURLParameter("metric");
	
	//draw the graph
	
	drawGraph(field,tablename,buckets,interval,startTime,metric,$("#graph"),$("#refresh"),$("#sql"));
	
})
	</script>
</body>
</html>
