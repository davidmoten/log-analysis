<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>log-analysis</title>
<link href="layout.css" rel="stylesheet" type="text/css">

<!--[if lte IE 8]><script language="javascript" type="text/javascript" src="../excanvas.min.js"></script><![endif]-->
<script type="text/javascript" src="js/flot/jquery.js"></script>
<script type="text/javascript" src="js/flot/jquery.flot.js"></script>
<script type="text/javascript" src="js/flot/jquery.flot.time.js"></script>

<link rel="stylesheet"
	href="http://code.jquery.com/ui/1.9.2/themes/base/jquery-ui.css" />
<!-- <script src="http://code.jquery.com/jquery-1.8.3.js"></script> -->
<script src="http://code.jquery.com/ui/1.9.2/jquery-ui.js"></script>

<style type="text/css">
div.inline {
	float: left;
}

.clearBoth {
	clear: both;
}
</style>

</head>
<body>
	<div style="width: 100%;height:100%; position:absolute;">
	<div id="graph" style="width: 90%; height: 80%;"></div>
	<div id="error"></div>
	<div id="refresh" class="inline" style="margin-left:25px;">
		<img src="images/refresh.png" style="height: 16px; width: 16px;" />
	</div>
	<br/>
	<textarea id="sql" class='inline' style="font-size:9px; width:50%;margin: 0px 100px  auto" value="" cols="50" rows="4"></textarea>
	
	</div>

	<script type="text/javascript">
	
		$(function() {

			function endsWith(str, suffix) {
			    return str.indexOf(suffix, str.length - suffix.length) !== -1;
			}
			
			function getURLParameter(name) {
				return decodeURIComponent((RegExp(name + '=' + '(.+?)(&|$)')
						.exec(location.search) || [ , null ])[1]);
			}

			function getAbsolutePath() {
				var loc = window.location;
				var pathName = loc.pathname.substring(0, loc.pathname
						.lastIndexOf('/') + 1);
				return loc.href
						.substring(
								0,
								loc.href.length
										- ((loc.pathname + loc.search + loc.hash).length - pathName.length));
			}

			var now = new Date().getTime();
			var field = getURLParameter('field');
			var tablename = getURLParameter("table");
			console.log(tablename);
			if (tablename == null || tablename=="null")
				tablename="Entry";
			
			
			var buckets = Number(getURLParameter("buckets"));
			var s = getURLParameter("interval");
			var interval;
			if (endsWith(s,"d"))
				interval = s.substring(0,s.length-1) * 24 * 3600000;
			else if (endsWith(s, "h"))
				interval = s.substring(0,s.length-1) * 3600000;
			else if (endsWith(s, "m"))
				interval = s.substring(0,s.length-1) * 60000;
			else if (endsWith(s, "s"))
				interval = s.substring(0,s.length-1) * 1000;
			else if (endsWith(s, "ms"))
				interval = s.substring(0,s.length-1);
			else 
				interval = Number(s);
			
			var finishTime = getURLParameter("finish");
			var metric = getURLParameter("metric");
			
			var sql = "select logTimestamp, " + field + " as value from " + tablename + " where " + field +" is not null order by logTimestamp";
			sql = sql.replace(new RegExp(" ", 'g'), "%20");
			
			var n;
			if (buckets == 0)
				n = 1;
			else
				n = buckets;

			if (getURLParameter("finish") == "now") {
				var startTime = now - n * interval;
			} else
				//TOOD parse finish time/start time from url parameters
				startTime = now - n * interval;

			var barOptions = {
				show : true,
				align : "center",
				barWidth : interval
			};

			function onDataReceived(series) {
				console.log(series);
				var n;
				if (buckets == 0) {
					n = 1;
					barOptions.barWidth = 0;
				} else {
					n = buckets;
				}

				//series.lines = { show: true, steps: true, fill: true };
				series.label=field;
				series.bars = barOptions;
				series.points = {
					show : true
				};
				var options = {
					xaxis : {
						mode : "time",
						timeformat : "%H:%M"
					}
				//,colors: ["#d18b2c", "#dba255","#dba255", "#919733","#919733"]
				};

				var finishTime = startTime + interval * n;

				var meanGraph = {
					label:"mean",
					data : [ [ startTime, series.stats.MEAN ],
							[ finishTime, series.stats.MEAN ] ],
					lines : {
						show : true
					}
				};
				console.log(series.stats);
				var metricValue = series.stats[metric];
				console.log("metric="+metricValue);
				var metricGraph = {
					label:metric.toLowerCase(),
					data : [ [ startTime, metricValue ],
							[ finishTime, metricValue ] ],
					lines : {
						show : true
					}
				};
				var sdUpperGraph = {
						label:"mean+sd",
					data : [
							[
									startTime,
									series.stats.MEAN
											+ series.stats.STANDARD_DEVIATION ],
							[
									finishTime,
									series.stats.MEAN
											+ series.stats.STANDARD_DEVIATION ] ],
					lines : {
						show : true
					}
				}
				var sdLowerGraph = {
					label: "mean-sd",
					data : [
							[
									startTime,
									series.stats.MEAN
											- series.stats.STANDARD_DEVIATION ],
							[
									finishTime,
									series.stats.MEAN
											- series.stats.STANDARD_DEVIATION ] ],
					lines : {
						show : true
					}
				}
				$.plot($("#graph"), [ series, meanGraph, sdLowerGraph,
						sdUpperGraph, metricGraph ], options);
			}

			$("#sql").text(sql.replace(new RegExp("%20", 'g'), " "));

			function refreshGraph() {
				var sql2 = $("#sql").val().replace(new RegExp(" ", 'g'), "%20");

				var dataurl = "data?sql=" + sql2 + "&start=" + startTime
						+ "&interval=" + interval + "&buckets=" + buckets
						+ "&metric=" + metric;
				console.log("dataurl=" + dataurl);

				$.ajax({
					url : dataurl,
					method : 'GET',
					dataType : 'json',
					success : onDataReceived,
					error : function(request, textStatus, errorThrown) {
						console.log(errorThrown);
						$("#error").text(errorThrown);
					},
					timeout : 60000
				});
			}
			refreshGraph();
			$("#refresh").click(function(event) {
				event.preventDefault();
				refreshGraph();
			});
		})
	</script>
</body>
</html>
